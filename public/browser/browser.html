<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axiom</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.min.js" integrity="sha256-AlTido85uXPlSyyaZNsjJXeCs07eSv3r43kyCVc8ChI=" crossorigin="anonymous"></script>
    <script src="./js/global.js" defer></script>
    <script src="./js/themeManager.js"></script>
    <script src="./js/plugins.js"></script>
    <script src="./js/auth.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/ui-lightness/jquery-ui.css">

    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--theme-primary);
            color: var(--theme-textPrimary);
            overflow: hidden;
        }

        #app {
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100vh;
        }

        #tab-bar {
            width: calc(100% - 65px);
            height: 40px;
            position: absolute;
            display: flex;
            gap: 8px;
            right: 0px;
        }

        .tab {
            border-radius: 5px;
            background-color: transparent;
            min-width: 120px;
            max-width: 200px;
            user-select: none;
            height: 25px;
            padding: 3px 6px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: var(--theme-textPrimary);
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }

        .tab.dragging {
            z-index: 1000;
            transform: rotate(3deg) scale(1.05);
            opacity: 0.9;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            transition: none;
        }

        .tab.drag-over {
            transform: translateX(5px);
            background-color: rgba(74, 158, 255, 0.1);
        }

        .tab.drag-placeholder {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .tab,
        #add-tab {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .tab:not(.dragging) {
            transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .tab:hover,
        #add-tab:hover {
            background-color: var(--theme-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--theme-shadow);
        }

        .tab.active {
            background-color: var(--theme-active);
        }

        .tab-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }

        #add-tab {
            border-radius: 60%;
            background-color: var(--theme-surfaceLight);
            min-width: 25px;
            max-width: 50px;
            user-select: none;
            height: 25px;
            padding: 2px;
            margin-top: 5px;
        }

        .exit {
            color: var(--theme-textSecondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .exit:hover {
            background-color: var(--theme-overlay);
            color: var(--theme-error);
            transform: scale(1.1);
        }

        .tab .exit {
            color: var(--theme-textSecondary) !important;
            transition: all 0.2s ease !important;
        }

        .tab .exit:hover {
            background-color: var(--theme-overlay) !important;
            color: var(--theme-error) !important;
            transform: scale(1.1) !important;
        }


        #url-bar {
            width: calc(100% - 80px);
            position: absolute;
            padding: 9px;
            right: 6px;
            border-radius: 8px;
            margin-top: 38px;
            border: none;
            display: flex;
            gap: 8px;
            height: 17px;
            align-items: center;
        }

        #url-input {
            padding: 8px;
            color: var(--theme-textPrimary);
            border: none;
            border-top-left-radius: 15px;
            border-bottom-left-radius: 15px;
            width: 30px;
            height: 15px;
            background-color: var(--theme-surface);
            padding-left: 8px;
            outline: none;
            width: 80%;
            transition: all 0.2s ease;
        }



        #url-bar button {
            border: none;
            background-color: transparent;
            color: var(--theme-textPrimary);
            cursor: pointer;
            height: 30px;
            width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        #url-bar button:hover {
            background-color: var(--theme-overlay);
            transform: scale(1.1);
        }

        #url-bar button:active {
            transform: scale(0.9);
        }

        .material-symbols-outlined,
        span.material-symbols-outlined,
        button .material-symbols-outlined,
        #sidebar button span.material-symbols-outlined,
        #add-tab span.material-symbols-outlined,
        #url-bar button span.material-symbols-outlined,
        .far-side-buttons button span.material-symbols-outlined {
            color: var(--theme-textPrimary) !important;
            transition: color 0.2s ease !important;
        }

        #url-bar button span.material-symbols-outlined {
            font-size: 20px;
        }

        .input-expansion span.material-symbols-outlined,
        .globe-icon.material-symbols-outlined {
            color: var(--theme-textSecondary) !important;
            font-size: 16px;
        }

        .tab .material-symbols-outlined,
        .exit.material-symbols-outlined {
            color: var(--theme-textSecondary) !important;
        }

        .tab .exit.material-symbols-outlined:hover,
        .exit.material-symbols-outlined:hover {
            color: var(--theme-error) !important;
        }

        .input-expansion {
            background-color: var(--theme-surface);
            border-top-right-radius: 15px;
            border-bottom-right-radius: 15px;
            height: 15px;
            padding: 8px;
            width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-right: 7px;
        }

        #input {
            display: flex;
            width: 100%;
        }

        #separator {
            background-color: var(--theme-surfaceLight);
            height: 60%;
            width: 1px;
            position: relative;
            margin: 0 4px;
        }

        #sidebar {
            height: 100%;
            width: 54px;
            margin-top: 15px;
            background-color: transparent;
            z-index: 55;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #sidebar img {
            width: 40px;
            height: 40px;
            filter: invert(1);
            margin-bottom: 8px;
            margin-top: 5px;
            border-radius: 6px;
            padding: 2px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .logo-separator-bottom {
            width: 35px;
            height: 1px;
            background-color: var(--theme-surfaceLight);
            margin: 8px 0 12px 0;
            opacity: 0.6;
        }

        .logo-separator-right {
            position: absolute;
            width: 1px;
            height: 50px;
            background-color: var(--theme-surfaceLight);
            right: -27px;
            top: 25px;
            opacity: 0.6;
        }

        #sidebar img:hover {
            transform: scale(1.05);
            opacity: 0.8;
        }

        #sidebar button {
            border: none;
            background-color: transparent;
            border-radius: 5px;
            color: var(--theme-textPrimary);
            cursor: pointer;
            height: 40px;
            margin-top: 6px;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        #sidebar button:hover {
            background-color: var(--theme-surfaceDark);
            transform: scale(1.05);
            box-shadow: 0 2px 8px var(--theme-shadow);
        }

        #sidebar button:active {
            transform: scale(0.95);
        }

        #iframe-container {
            width: calc(100% - 54px);
            position: absolute;
            right: 0px;
            bottom: 0px;
            height: calc(100% - 75px);
            border-top-left-radius: 15px;
            border: none;
        }

        #iframe-container iframe {
            width: 100%;
            height: 100%;
            bottom: 0px;
            right: 0px;
            border-top-left-radius: 15px;
            border: none;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--theme-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-top-left-radius: 15px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--theme-surfaceLight);
            border-top: 4px solid var(--theme-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #bottom-sidebar {
            position: absolute;
            bottom: 15px;
            width: 54px;
        }

        #sidemenu {
            border-radius: 15px;
            position: absolute;
            top: 90px;
            height: calc(100% - 115px);
            width: 400px;
            z-index: 35;
            left: 65px;
            background-color: transparent;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transform: translateX(-100%);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            opacity: 0;
        }

        #sidemenu.active {
            transform: translateX(0);
            opacity: 1;
        }

        #sidemenu iframe {
            border: none;
            border-radius: 15px;
            height: 100%;
            width: 100%;
            background-color: var(--theme-textPrimary);
        }

        .far-side-buttons {
            display: flex;
        }

        .extensions {
            padding-left: 5px;
            padding-right: 5px;
            background-color: var(--theme-active);
            border-radius: 68px;
            margin-right: 5px;
        }

        .window {
            position: absolute;
            padding-top: 5px;
            backdrop-filter: blur(15px);
            background:  var(--theme-windowBackground);
            border-radius: 5px;
            width: 300px;

            height: 300px;
                        overflow: hidden;
        }

        .title-bar {
            margin-bottom: 5px;
            user-select: none;
            margin-left: 5px;
        }

        .title-bar span {
            filter: invert(1);
        }

        .window-controls {
            position: absolute;
            right: 5px;
            top: 5px;
            display: flex;
            gap: 5px;
        }

        .close {
            width: 10px;
            height: 10px;
            margin-top: 5px;
            background-color: #f05c5c;
            border-radius: 50%;
            cursor: pointer;
        }
        .dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--theme-surface);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            color: var(--theme-textPrimary);
            max-width: 400px;
            width: 90%;
        }

        .dialog-message {
            margin-bottom: 20px;
            font-size: 16px;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .dialog-button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: var(--theme-primary);
            color: var(--theme-textPrimary);
            transition: background-color 0.2s ease;
        }

        .dialog-button:hover {
            background-color: var(--theme-hover);
        }

        .dialog-button-positive {
            background-color: var(--theme-accent);
        }

        .dialog-button-positive:hover {
            background-color: var(--theme-accentHover);
        }

        .dialog-button-negative {
            background-color: var(--theme-error);
        }

        .dialog-button-negative:hover {
            background-color: var(--theme-errorHover);
        }

    </style>
</head>

<body>
    <div id="app">

        <div id="sidemenu">
            <!-- dont wake up -->

            <iframe id="sidebar-frame-ai" src="./features/ai.html" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;" use="ai"></iframe>
            <iframe id="sidebar-frame-yt" src="./features/yt.html" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;" use="yt"></iframe>

        </div>

        <div id="sidebar">
            <!-- AXIOM ON TOP-->
            <img src="assets/trans-logo.png">

            <button onclick="sidebarload('yt')">
                <span class="material-symbols-outlined">play_arrow</span>
            </button>
            <button onclick="load('games')">
                <span class="material-symbols-outlined">stadia_controller</span>
            </button>
            <button onclick="load('movies')">
                <span class="material-symbols-outlined">movie</span>
            </button>
            <button onclick="sidebarload('ai')">
                <span class="material-symbols-outlined">network_intelligence</span>
            </button>
            <div id="bottom-sidebar">
                            <button id="login-sidebar-button">
                <span class="material-symbols-outlined">account_circle</span>
            </button>
                <button onclick="openSettings()">
                    <span class="material-symbols-outlined">settings</span>
                </button>
            </div>
        </div>
        <div id="tab-bar">
            <div id="add-tab" onclick="addtab()">
                <span class="material-symbols-outlined">add</span>
            </div>
        </div>
        <div id="url-bar">
            <button>
                <span class="material-symbols-outlined">arrow_back</span>
            </button>
            <button>
                <span class="material-symbols-outlined">arrow_forward</span>
            </button>
            <button>
                <span class="material-symbols-outlined">refresh</span>
            </button>
            <div id="input">
                <input type="text" id="url-input" placeholder="What are you looking for today?" />
                <div class="input-expansion">
                    <span class="material-symbols-outlined globe-icon">globe</span>
                </div>
            </div>
            <div class="far-side-buttons" style="display: none;">
                <div class="extensions" id="extensions">
                                    <button>
                    <span class="material-symbols-outlined">extension</span>
                </button>
                </div>

                <button>
                    <span class="material-symbols-outlined">menu</span>
                </button>
            </div>
        </div>

        <div id="iframe-container">
            <iframe id="iframe" src="./start.html"></iframe>
        </div>

    </div>
<script>

        let active = false;
        let activeApp = "";
        let tabs = [];
        let currentTabId = 0;
        let isTyping = false;
        let nextTabId = 1;
        let draggedTab = null;
        let dragStartX = 0;
        let dragStartIndex = 0;


        function createDefaultTab() {
            try {
                const homepage = getHomepageURL();
                const homepageTitle = getHomepageTitle();
                addtab(homepageTitle || "New Tab", homepage || "./start.html");
            } catch (error) {
                addtab("New Tab", "./start.html");
            }
        }

        function addtab(name = "New Tab", url = null) {
            try {
                if (!name || typeof name !== 'string') {
                    name = "New Tab";
                }

                const tabId = nextTabId++;
                const tab = {
                    id: tabId,
                    title: name,
                    url: url || "./start.html",
                    element: null
                };

                tabs.push(tab);

                const tabElement = document.createElement('div');
                tabElement.className = 'tab';
                tabElement.setAttribute('data-tab-id', tabId);

                tabElement.innerHTML = `
                    <div class="tab-title">${name}</div>
                    <div class="exit">×</div>
                `;

                tabElement.addEventListener('click', (e) => {
                    if (e.target.classList.contains('exit')) {
                        closetab(tabId);
                    } else {
                        switchTab(tabId);
                    }
                });

                const tabBar = document.getElementById('tab-bar');
                const addTabButton = document.getElementById('add-tab');
                tabBar.insertBefore(tabElement, addTabButton);

                tab.element = tabElement;

                setupTabDragAndDrop(tabElement, tabId);

                if (tabs.length === 1 || !document.querySelector('.tab.active')) {
                    switchTab(tabId);
                }

                console.log(`Tab created: ${name} (ID: ${tabId})`);
                return tabId;
            } catch (error) {
                console.error('Error creating tab:', error);
                return null;
            }
        }

        function closetab(tabId) {
            try {
                const tabIndex = tabs.findIndex(tab => tab.id === tabId);
                if (tabIndex === -1) {
                    console.error('Tab not found:', tabId);
                    return;
                }

                const tab = tabs[tabIndex];
                const isActive = tab.element.classList.contains('active');
                const wasLastTab = tabs.length === 1;

                if (tab.element && tab.element.parentNode) {
                    tab.element.remove();
                }

                tabs.splice(tabIndex, 1);

                if (wasLastTab) {
                    currentTabId = 0;
                    createDefaultTab();
                } else if (isActive) {
                    let newActiveIndex = tabIndex;
                    if (newActiveIndex >= tabs.length) {
                        newActiveIndex = tabs.length - 1;
                    }
                    if (tabs[newActiveIndex]) {
                        switchTab(tabs[newActiveIndex].id);
                    }
                }

                console.log(`Tab closed: ${tab.title} (ID: ${tabId})`);
            } catch (error) {
                console.error('Error closing tab:', error);
            }
        }

        function switchTab(tabId) {
            try {
                const tab = tabs.find(tab => tab.id === tabId);
                if (!tab) {
                    console.error('Tab not found for switching:', tabId);
                    return;
                }

                document.querySelectorAll('.tab').forEach(tabEl => {
                    tabEl.classList.remove('active');
                });

                if (tab.element) {
                    tab.element.classList.add('active');
                }

                currentTabId = tabId;

                const iframe = document.getElementById('iframe');
                if (iframe) {
                    iframe.src = tab.url;
                }

                const urlInput = document.getElementById('url-input');
                if (urlInput) {
                    urlInput.value = tab.url;
                }

                console.log(`Switched to tab: ${tab.title} (ID: ${tabId})`);
            } catch (error) {
                console.error('Error switching tab:', error);
            }
        }

        function getHomepageURL() {
            try {
                const savedHomepage = localStorage.getItem('axiomHomepage');
                if (savedHomepage && savedHomepage !== 'custom') {
                    return savedHomepage === 'start.html' ? './start.html' : './start.html';
                }

                const customHomepage = localStorage.getItem('axiomCustomHomepage');
                if (customHomepage) {
                    return customHomepage;
                }

                return './start.html';
            } catch (error) {
                console.error('Error getting homepage URL:', error);
                return './start.html';
            }
        }

        function getHomepageTitle() {
            try {
                const savedHomepage = localStorage.getItem('axiomHomepage');
                if (savedHomepage === 'start.html') return 'Axiom Start';
                if (savedHomepage === 'games.html') return 'Games';
                if (savedHomepage === 'custom') {
                    const customUrl = localStorage.getItem('axiomCustomHomepage');
                    return customUrl ? new URL(customUrl).hostname : 'Custom Page';
                }
                return 'New Tab';
            } catch (error) {
                console.error('Error getting homepage title:', error);
                return 'New Tab';
            }
        }

        function saveTabs() {
            try {
                if (Array.isArray(tabs) && tabs.length > 0) {
                    const cleanTabs = tabs.map(tab => ({
                        id: tab.id,
                        title: tab.title || 'Untitled',
                        url: tab.url || './start.html'
                    }));
                    localStorage.setItem("tabs", JSON.stringify(cleanTabs));
                } else {
                    localStorage.removeItem("tabs");
                }
            } catch (error) {
                console.error('Failed to save tabs:', error);
                try {
                    if (tabs && tabs.length > 0) {
                        localStorage.setItem("tabs_backup", JSON.stringify(tabs));
                    }
                } catch (backupError) {
                    console.error('Failed to create backup:', backupError);
                }
            }
        }

        function restoreTabs(savedTabs) {
            try {
                if (!Array.isArray(savedTabs) || savedTabs.length === 0) {
                    createDefaultTab();
                    return;
                }

                let restoredCount = 0;
                savedTabs.forEach(tabData => {
                    if (tabData && typeof tabData === 'object' &&
                        (tabData.title || tabData.url)) {
                        try {
                            addtab(
                                tabData.title || 'Restored Tab',
                                tabData.url || './start.html'
                            );
                            restoredCount++;
                        } catch (tabError) {
                            console.error('Failed to restore tab:', tabError);
                        }
                    }
                });

                if (restoredCount === 0) {
                    createDefaultTab();
                }

                console.log(`Restored ${restoredCount} tabs`);
            } catch (error) {
                console.error('Error restoring tabs:', error);
                createDefaultTab();
            }
        }

        function initializeTabs() {
            try {
                const savedTabs = localStorage.getItem("tabs");
                if (savedTabs) {
                    const parsedTabs = JSON.parse(savedTabs);
                    restoreTabs(parsedTabs);
                } else {
                    createDefaultTab();
                }
            } catch (error) {
                console.error('Error initializing tabs:', error);
                createDefaultTab();
            }
        }
        initializeTabs();

        function setupTabDragAndDrop(tabElement, tabId) {
            let dragStartX = 0;
            let dragStartIndex = -1;

            tabElement.draggable = true;

            tabElement.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'move';
                tabElement.classList.add('dragging');
 const allTabs = Array.from(document.querySelectorAll('.tab'));
                dragStartIndex = allTabs.indexOf(tabElement);

                e.dataTransfer.setData('text/plain', tabId.toString());
            });

            tabElement.addEventListener('dragend', () => {
                tabElement.classList.remove('dragging');
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('drag-over');
                });
            });

            tabElement.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            tabElement.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggedTabId = parseInt(e.dataTransfer.getData('text/plain'));

                if (draggedTabId === tabId) return; 

                reorderTabs(draggedTabId, tabId);
            });
        }

        function reorderTabs(draggedTabId, targetTabId) {
            try {
                const draggedTabIndex = tabs.findIndex(tab => tab.id === draggedTabId);
                const targetTabIndex = tabs.findIndex(tab => tab.id === targetTabId);

                if (draggedTabIndex === -1 || targetTabIndex === -1) return;
                const draggedTab = tabs.splice(draggedTabIndex, 1)[0];

                const newIndex = targetTabIndex > draggedTabIndex ? targetTabIndex : targetTabIndex;
                tabs.splice(newIndex, 0, draggedTab);

                const tabBar = document.getElementById('tab-bar');
                const draggedElement = draggedTab.element;
                const targetElement = tabs.find(tab => tab.id === targetTabId).element;

                if (targetTabIndex > draggedTabIndex) {
                    tabBar.insertBefore(draggedElement, targetElement.nextSibling);
                } else {
                    tabBar.insertBefore(draggedElement, targetElement);
                }

                console.log(`Reordered tabs: ${draggedTab.title} moved to position ${newIndex}`);
            } catch (error) {
                console.error('Error reordering tabs:', error);
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                addtab();
            }

            if (e.ctrlKey && e.key === 'w') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabId = parseInt(activeTab.getAttribute('data-tab-id'));
                    closetab(tabId);
                }
            }

            if (e.ctrlKey && e.key === 'Tab') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const currentIndex = tabs.findIndex(tab => tab.element === activeTab);
                    const nextIndex = (currentIndex + 1) % tabs.length;
                    if (tabs[nextIndex]) {
                        switchTab(tabs[nextIndex].id);
                    }
                }
            }

            if (e.ctrlKey && e.shiftKey && e.key === 'Tab') {
                e.preventDefault();
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const currentIndex = tabs.findIndex(tab => tab.element === activeTab);
                    const prevIndex = currentIndex === 0 ? tabs.length - 1 : currentIndex - 1;
                    if (tabs[prevIndex]) {
                        switchTab(tabs[prevIndex].id);
                    }
                }
            }
        });

        setInterval(saveTabs, 100);

        function updateTabTitleAndUrl() {
            try {
                const iframe = document.getElementById('iframe');
                const currentTab = document.querySelector('.tab.active');

                if (!iframe || !currentTab || !Array.isArray(tabs)) return;

                const tabIdAttr = currentTab.getAttribute('data-tab-id');
                if (!tabIdAttr) return;

                const tabId = parseInt(tabIdAttr);
                if (isNaN(tabId)) return;

                const tabData = tabs.find(t => t && t.id === tabId);
                if (!tabData || !iframe.contentWindow) return;

                try {
                    const iframeDoc = iframe.contentWindow.document;
                    if (!iframeDoc) return;

                    if (iframeDoc.location && iframeDoc.location.href && 
                        iframeDoc.location.href !== tabData.url) {
                        tabData.url = iframeDoc.location.href;
                        updateUrlBar(iframeDoc.location.href);
                    }

                    if (iframeDoc.title && iframeDoc.title !== tabData.title && 
                        iframeDoc.title.trim() !== '') {
                        tabData.title = iframeDoc.title;
                        updateTabDisplay(tabId, iframeDoc.title);
                    }
                } catch (e) {
                    monitorIframeChanges(tabId, iframe);
                }
            } catch (error) {
                console.error('Error updating tab title and URL:', error);
            }
        }

        function updateUrlBar(url) {
            try {
                const urlInput = document.getElementById('url-input');
                if (!urlInput || !url || typeof url !== 'string') return;

                let processedUrl = url;
                
                try {
                    if (processedUrl.includes("prxy.html") && processedUrl.includes("url=")) {
                        const urlParam = processedUrl.split("url=")[1];
                        if (urlParam) {
                            processedUrl = atob(urlParam);
                        }
                    } else if (processedUrl.startsWith(window.location.origin) && !processedUrl.includes("prxy")) {
                        const pathParts = processedUrl.split("/");
                        const filename = pathParts[pathParts.length - 1];
                        if (filename) {
                            const pageName = filename.split(".html")[0];
                            processedUrl = "axiom://" + pageName;
                        }
                    } else if (!processedUrl.includes(".")) {
                        const searchEngine = localStorage.getItem("search") || "https://search.brave.com/search?q=";
                        processedUrl = searchEngine + encodeURIComponent(processedUrl);
                    }
                } catch (e) {
                    processedUrl = url;
                }

                urlInput.value = processedUrl;
            } catch (error) {
                console.error('Error updating URL bar:', error);
            }
        }

        function updateTabDisplay(tabId, newTitle) {
            try {
                if (!tabId || !newTitle || typeof newTitle !== 'string') return;
                
                const tab = document.querySelector(`[data-tab-id="${tabId}"]`);
                if (!tab) return;
                
                const titleSpan = tab.querySelector('.tab-title');
                if (titleSpan) {
                    titleSpan.textContent = newTitle.trim();
                }
            } catch (error) {
                console.error('Error updating tab display:', error);
            }
        }

        function monitorIframeChanges(tabId, iframe) {
            try {
                if (!tabId || !iframe || typeof iframe.addEventListener !== 'function') return;
                
                iframe.addEventListener('load', () => {
                    try {
                        if (!iframe.contentWindow || !iframe.contentWindow.document) return;
                        
                        const iframeDoc = iframe.contentWindow.document;
                        const title = iframeDoc.title;

                        if (title && typeof title === 'string' && title.trim() !== '') {
                            const tabData = tabs.find(t => t && t.id === tabId);
                            if (tabData && tabData.title !== title) {
                                tabData.title = title;
                                updateTabDisplay(tabId, title);
                            }
                        }
                    } catch (e) {
                        console.log('Cross-origin iframe detected, limited functionality');
                    }
                });
            } catch (error) {
                console.error('Error monitoring iframe changes:', error);
            }
        }
        setInterval(updateTabTitleAndUrl, 100);


        function updateUrlInputOnSwitch(tabId) {
            try {
                if (!tabId) return;
                
                const tabData = tabs.find(t => t && t.id === tabId);
                const urlInput = document.getElementById('url-input');
                
                if (tabData && urlInput && tabData.url) {
                    urlInput.value = tabData.url;
                }
            } catch (error) {
                console.error('Error updating URL input on switch:', error);
            }
        }

        function switchTab(tabId) {
            try {
                if (!tabId) return;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                const selectedTab = document.querySelector(`[data-tab-id="${tabId}"]`);
                
                if (selectedTab) {
                    selectedTab.classList.add('active');
                    currentTabId = tabId;
                    
                    const tabData = tabs.find(t => t && t.id === tabId);
                    const iframe = document.getElementById('iframe');
                    
                    if (tabData && iframe && tabData.url) {
                        iframe.src = tabData.url;
                        
                        setTimeout(() => {
                            injectDevToolsIntoIframe();
                        }, 1000);
                    }
                }
                
                updateUrlInputOnSwitch(tabId);
            } catch (error) {
                console.error('Error switching tab:', error);
            }
        }

        document.getElementById('url-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const url = this.value.trim();
                if (url) {
                    processUrl(url);
                }
            }
        });

        function processUrl(input) {
            let url = input;

            if (!url.match(/^https?:\/\//i)) {
                if (url.includes('.') && !url.includes(' ')) {
                    url = 'https://' + url;
                } else {
                    url = getSearchEngine() + encodeURIComponent(url);
                }
            }

            const currentTab = tabs.find(t => t.id === currentTabId);
            if (currentTab) {
                currentTab.url = url;
                document.getElementById('iframe').src = url;
            }
        }

        document.querySelector('#url-bar > button:nth-child(1)').onclick = function() {
            try {
                document.getElementById('iframe').contentWindow.history.back();
            } catch (e) {
                console.log('Navigation blocked by cross-origin policy');
            }
        };

        document.querySelector('#url-bar > button:nth-child(2)').onclick = function() {
            try {
                document.getElementById('iframe').contentWindow.history.forward();
            } catch (e) {
                console.log('Navigation blocked by cross-origin policy');
            }
        };

        document.querySelector('#url-bar > button:nth-child(3)').onclick = function() {
            document.getElementById('iframe').src = document.getElementById('iframe').src;
        };

        document.addEventListener('dblclick', function(e) {
            const iframe = document.getElementById('iframe');
            if (e.target.closest('#iframe-container')) {
                if (!document.fullscreenElement) {
                    iframe.requestFullscreen().catch(console.log);
                } else {
                    document.exitFullscreen().catch(console.log);
                }
            }
        });


        function load(item){
            if (item == "games"){
                addtab("Games", "games.html");
            }
            if (item == "movies"){
                addtab("Movies", "./features/movies.html");
            }
        }

        function addtab(name="New Tab", url=null) {
            if (!url) {
                url = getHomepageURL();
                if (name === "New Tab") {
                    name = getHomepageTitle();
                }
            }
            const tabId = nextTabId++;
            const tab = document.createElement("div");
            tab.classList.add("tab");
            tab.setAttribute("data-tab-id", tabId);
            tab.draggable = true;
            tab.innerHTML = `
                <span class="tab-title">${name}</span>
                <span class="material-symbols-outlined exit" onclick="closetab(this)">close</span>
            `;
            tab.onclick = (e) => {
                if (!e.target.classList.contains('exit')) {
                    switchTab(tabId);
                }
            };

            addDragListeners(tab);

            tabs.push({ id: tabId, title: name, url: url });
            document.getElementById("tab-bar").insertBefore(tab, document.getElementById("add-tab"));
            switchTab(tabId);
        }

        function closetab(exitButton) {
            const tab = exitButton.closest('.tab');
            const tabId = parseInt(tab.getAttribute('data-tab-id'));

            if (tabs.length <= 1) return;

            tabs = tabs.filter(t => t.id !== tabId);

            if (currentTabId === tabId) {
                const remainingTab = tabs[0];
                switchTab(remainingTab.id);
            }

            tab.remove();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const selectedTab = document.querySelector(`[data-tab-id="${tabId}"]`);
            if (selectedTab) {
                selectedTab.classList.add('active');
                currentTabId = tabId;
                const tabData = tabs.find(t => t.id === tabId);
                if (tabData) {
                    document.getElementById('iframe').src = tabData.url;
                    
                    setTimeout(() => {
                        injectDevToolsIntoIframe();
                    }, 1000);
                }
            }
        }

        function addDragListeners(tab) {
            tab.addEventListener('dragstart', handleDragStart);
            tab.addEventListener('dragend', handleDragEnd);
            tab.addEventListener('dragover', handleDragOver);
            tab.addEventListener('drop', handleDrop);
        }

        function handleDragStart(e) {
            try {
                if (!e || !this) return;
                
                draggedTab = this;
                dragStartX = e.clientX || 0;
                
                const parent = this.parentNode;
                if (parent && parent.children) {
                    dragStartIndex = Array.from(parent.children).indexOf(this);
                }
                
                setTimeout(() => {
                    if (this && this.classList) {
                        this.classList.add('dragging');
                    }
                }, 0);
                
                if (e.dataTransfer) {
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', this.outerHTML || '');
                }
                
                const tabs = document.querySelectorAll('.tab');
                if (tabs) {
                    tabs.forEach(tab => {
                        if (tab !== this && tab.style) {
                            tab.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                        }
                    });
                }
            } catch (error) {
                console.error('Error in drag start:', error);
            }
        }

        function handleDragEnd(e) {
            try {
                setTimeout(() => {
                    try {
                        if (this && this.classList) {
                            this.classList.remove('dragging');
                        }
                        
                        const tabs = document.querySelectorAll('.tab');
                        if (tabs) {
                            tabs.forEach(tab => {
                                if (tab && tab.classList && tab.style) {
                                    tab.classList.remove('drag-over', 'drag-placeholder');
                                    tab.style.transition = '';
                                }
                            });
                        }
                        
                        draggedTab = null;
                    } catch (error) {
                        console.error('Error in drag end timeout:', error);
                    }
                }, 50);
            } catch (error) {
                console.error('Error in drag end:', error);
            }
        }

        function handleDragOver(e) {
            try {
                if (e && e.preventDefault) {
                    e.preventDefault();
                }
                
                if (this !== draggedTab) {
                    const tabs = document.querySelectorAll('.tab');
                    if (tabs) {
                        tabs.forEach(tab => {
                            if (tab && tab.classList) {
                                tab.classList.remove('drag-over');
                            }
                        });
                    }
                    
                    if (this && this.classList) {
                        this.classList.add('drag-over');
                    }
                }
                
                if (e && e.dataTransfer) {
                    e.dataTransfer.dropEffect = 'move';
                }
                
                return false;
            } catch (error) {
                console.error('Error in drag over:', error);
                return false;
            }
        }

        function handleDrop(e) {
            try {
                if (e && e.stopPropagation) {
                    e.stopPropagation();
                }

                if (draggedTab !== this && draggedTab && this && Array.isArray(tabs)) {
                    const draggedTabId = parseInt(draggedTab.getAttribute('data-tab-id') || '0');
                    const targetTabId = parseInt(this.getAttribute('data-tab-id') || '0');
                    
                    if (isNaN(draggedTabId) || isNaN(targetTabId)) return false;
                    
                    const draggedIndex = tabs.findIndex(t => t && t.id === draggedTabId);
                    const targetIndex = tabs.findIndex(t => t && t.id === targetTabId);
                    
                    if (draggedIndex === -1 || targetIndex === -1) return false;
                    
                    const draggedTabData = tabs.splice(draggedIndex, 1)[0];
                    if (draggedTabData) {
                        tabs.splice(targetIndex, 0, draggedTabData);
                    }
                    
                    const parent = this.parentNode;
                    const draggedElement = draggedTab;
                    const targetElement = this;
                    
                    if (parent && draggedElement && targetElement) {
                        if (draggedElement.style) {
                            draggedElement.style.transition = 'all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                        }
                        
                        if (draggedIndex < targetIndex) {
                            parent.insertBefore(draggedElement, targetElement.nextSibling);
                        } else {
                            parent.insertBefore(draggedElement, targetElement);
                        }
                    }
                    
                    setTimeout(() => {
                        try {
                            const tabs = document.querySelectorAll('.tab');
                            if (tabs) {
                                tabs.forEach(tab => {
                                    if (tab && tab.classList) {
                                        tab.classList.remove('drag-over');
                                    }
                                });
                            }
                        } catch (error) {
                            console.error('Error in drop cleanup:', error);
                        }
                    }, 100);
                }

                return false;
            } catch (error) {
                console.error('Error in drop handler:', error);
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            try {
                const firstTab = document.querySelector('.tab');
                if (firstTab) {
                    firstTab.draggable = true;
                    if (typeof addDragListeners === 'function') {
                        addDragListeners(firstTab);
                    }
                    firstTab.onclick = (e) => {
                        try {
                            if (e && e.target && e.target.classList && !e.target.classList.contains('exit')) {
                                if (typeof switchTab === 'function') {
                                    switchTab(0);
                                }
                            }
                        } catch (error) {
                            console.error('Error in first tab click handler:', error);
                        }
                    };
                }
            } catch (error) {
                console.error('Error in DOMContentLoaded handler:', error);
            }
        });

        function sidebarload(app) {
            try {
                if (!app || typeof app !== 'string') return;
                
                const sidemenu = document.getElementById("sidemenu");
                if (!sidemenu) return;
                
                const sidebarFrame = document.querySelector(`[use="${app}"]`);

                if (active && activeApp === app) {
                    if (sidemenu.classList) {
                        sidemenu.classList.remove("active");
                    }
                    
                    setTimeout(() => {
                        try {
                            if (sidemenu && sidemenu.classList && !sidemenu.classList.contains('active')) {
                                if (sidemenu.style) {
                                    sidemenu.style.display = "none";
                                }
                                
                                const frames = document.querySelectorAll('#sidemenu iframe');
                                if (frames) {
                                    frames.forEach(frame => {
                                        if (frame && frame.style) {
                                            frame.style.opacity = "0";
                                            frame.style.pointerEvents = "none";
                                        }
                                    });
                                }
                            }
                        } catch (error) {
                            console.error('Error in sidebar close timeout:', error);
                        }
                    }, 300);
                    
                    active = false;
                    activeApp = "";
                    return;
                }

                if (sidemenu.style) {
                    sidemenu.style.display = "block";
                }

                const frames = document.querySelectorAll('#sidemenu iframe');
                if (frames) {
                    frames.forEach(frame => {
                        if (frame && frame.style) {
                            frame.style.opacity = "0";
                            frame.style.pointerEvents = "none";
                        }
                    });
                }

                if (sidebarFrame && sidebarFrame.style) {
                    sidebarFrame.style.opacity = "1";
                    sidebarFrame.style.pointerEvents = "all";
                    activeApp = app;

                    if (!active) {
                        requestAnimationFrame(() => {
                            try {
                                if (sidemenu && sidemenu.classList) {
                                    sidemenu.classList.add("active");
                                }
                            } catch (error) {
                                console.error('Error adding active class:', error);
                            }
                        });
                        active = true;
                    }
                }
            } catch (error) {
                console.error('Error in sidebarload:', error);
            }
        }

        setInterval(() => {
            try {
                if (isTyping) return;
                
                const iframe = document.getElementById("iframe");
                const urlInput = document.getElementById("url-input");
                
                if (!iframe || !urlInput || !Array.isArray(tabs)) return;
                
                let x = null;
                try {
                    const contentDoc = iframe.contentDocument;
                    if (contentDoc && contentDoc.location) {
                        x = contentDoc.location.href;
                    }
                } catch (e) {
                    return;
                }
                
                if (!x) return;
                
                if (x.includes("prxy.html")  && x.includes("url=") || x.includes("prxy_sj.html") && x.includes("url=") || x.includes("prxy_uv.html") && x.includes("url=")) {
                    const urlPart = x.split("url=")[1];
                    if (urlPart) {
                        try {
                            x = atob(urlPart);
                        } catch (e) {
                            console.error('Error decoding URL:', e);
                            return;
                        }
                    }
                }
                
                if (x.startsWith(window.location.origin) && !x.includes("prxy.html") || x.startsWith(window.location.origin) && !x.includes("prxy_sj.html") || x.startsWith(window.location.origin) && !x.includes("prxy_uv.html")) {
                    const pathParts = x.split("/");
                    if (pathParts.length > 0) {
                        const lastPart = pathParts[pathParts.length - 1];
                        if (lastPart) {
                            x = "axiom://" + lastPart.split(".html")[0];
                        }
                    }
                }
                
                try {
                    const contentDoc = iframe.contentDocument;
                    if (contentDoc && contentDoc.title) {
                        const currentTitle = contentDoc.title;
                        
                        tabs.forEach(tab => {
                            if (tab && tab.id === currentTabId) {
                                tab.title = currentTitle;
                            }
                        });
                    }
                } catch (e) {
                    
                }
                
                urlInput.value = x;
            } catch (error) {
                console.error('Error in URL update interval:', error);
            }
        }, 100);

        try {
            const urlInput = document.getElementById("url-input");
            if (urlInput) {
                urlInput.addEventListener("focus", function () {
                    isTyping = true;
                });

                urlInput.addEventListener("blur", function () {
                    isTyping = false;
                });
            }
        } catch (error) {
            console.error('Error setting up URL input listeners:', error);
        }

        function goto(url) {
            try {
                if (!url || typeof url !== 'string') return;
                
                const iframe = document.getElementById("iframe");
                if (!iframe) return;
                
                iframe.src = url;
                
                if (Array.isArray(tabs)) {
                    tabs.forEach(tab => {
                        if (tab && tab.id === currentTabId) {
                            tab.url = url;
                        }
                    });
                }
                
                setTimeout(() => {
                    try {
                        if (typeof injectDevToolsIntoIframe === 'function') {
                            injectDevToolsIntoIframe();
                        }
                    } catch (error) {
                        console.error('Error injecting dev tools:', error);
                    }
                }, 1000);
            } catch (error) {
                console.error('Error in goto function:', error);
            }
        }

        function injectDevToolsIntoIframe() {
            try {
                const developerMode = localStorage.getItem('axiomDeveloperMode') === 'true';
                const iframe = document.getElementById("iframe");
                
                if (!developerMode || !iframe) return;
                
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc && iframeDoc.head && !iframeDoc.querySelector('script[data-eruda]')) {
                        const script = iframeDoc.createElement('script');
                        if (script) {
                            script.src = 'https://cdn.jsdelivr.net/npm/eruda@3.0.1/eruda.min.js';
                            script.setAttribute('data-eruda', 'true');
                            script.onload = function() {
                                try {
                                    if (iframe.contentWindow && iframe.contentWindow.eruda) {
                                        iframe.contentWindow.eruda.init({
                                            container: iframeDoc.body,
                                            tool: ['console', 'elements', 'network'],
                                            defaults: {
                                                displaySize: 40,
                                                transparency: 0.8
                                            }
                                        });
                                    }
                                } catch (initError) {
                                    console.error('Error initializing eruda:', initError);
                                }
                            };
                            
                            script.onerror = function() {
                                console.error('Failed to load eruda script');
                            };
                            
                            iframeDoc.head.appendChild(script);
                        }
                    }
                } catch (e) {
                    console.log('Cannot inject dev tools into cross-origin iframe');
                }
            } catch (error) {
                console.error('Error in injectDevToolsIntoIframe:', error);
            }
        }

        function openApp(name, url) {
            try {
                if (!name || !url || typeof name !== 'string' || typeof url !== 'string') {
                    console.error('Invalid name or URL provided to openApp');
                    return;
                }
                
                const id = Math.floor(Math.random() * 1000000000);
                const bodyElement = document.getElementById("body");
                
                if (!bodyElement) {
                    console.error('Body element not found');
                    return;
                }
                
                const safeName = name.replace(/[<>"']/g, '');
                const safeUrl = url.replace(/[<>"']/g, '');
                
                const windowHTML = `
                <div class="window" id="${id}" onclick="arrange('${id}')">
                    <div class="title-bar">
                        <span>${safeName}</span>
                        <div class="window-controls">                        
                            <div class="maximize" onclick="maximize('${id}')"></div>
                            <div class="minimize" onclick="minimize('${id}')"></div>
                            <div class="close" onclick="closeWindow('${id}')"></div>
                        </div>
                    </div>
                    <div class="content">
                        <iframe onclick="arrange('${id}')" src="${safeUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </div>
                </div>
                `;
                
                bodyElement.insertAdjacentHTML("beforeend", windowHTML);
                
                const windowElement = document.getElementById(id);
                if (windowElement) {
                    windowElement.style.zIndex = (highestZIndex || 0) + 1;
                    highestZIndex = (highestZIndex || 0) + 1;
                    
                    if (typeof $ !== 'undefined' && $.fn.draggable && $.fn.resizable) {
                        try {
                            const desktop = document.getElementById("desktop");
                            $(`#${id}`).draggable().resizable({
                                containment: desktop || 'document'
                            });
                        } catch (jqueryError) {
                            console.error('Error initializing jQuery UI:', jqueryError);
                        }
                    }
                    
                    if (Array.isArray(stack)) {
                        stack.push(id);
                    }
                }
            } catch (error) {
                console.error('Error in openApp:', error);
            }
        }

        // the fucking fucking fucking interval for miniplayer
        let activeminiplayer = false // make sure we don't make 3^3^3^3^3^3^3^3 intervals in less than a second
        setInterval(() => {
            try {
                const currentVideoId = localStorage.getItem("currentVideoId");
                if (currentVideoId && activeminiplayer === false) {
                    const inIframe = window.self !== window.top;
                    if (!inIframe && typeof openApp === 'function') {
                        activeminiplayer = true;
                        openApp("Miniplayer", "https://www.youtube.com/embed/" + currentVideoId);
                        localStorage.removeItem("currentVideoId");
                        
                        setTimeout(() => {
                            activeminiplayer = false;
                        }, 1000);
                    }
                }
            } catch (error) {
                console.error('Error in miniplayer interval:', error);
            }
        }, 100);

        try {
            const urlInput = document.getElementById("url-input");
            if (urlInput) {
                urlInput.addEventListener("keydown", async function (key) {
                    try {
                        if (key && key.code === "Enter") {
                            const inputValue = this.value;
                            if (!inputValue || typeof inputValue !== 'string') return;
                            
                            if (inputValue.startsWith("axiom://")) {
                                const page = inputValue.split("//")[1];
                                if (page && typeof goto === 'function') {
                                    goto(page + ".html");
                                }
                            } else {
                                let processedUrl = inputValue;
                                
                                if (!processedUrl.includes(".")) {
                                    if (typeof getSearchEngine === 'function') {
                                        processedUrl = getSearchEngine() + encodeURIComponent(processedUrl);
                                    } else {
                                        processedUrl = 'https://search.brave.com/search?q=' + encodeURIComponent(processedUrl);
                                    }
                                }
                                
                                if (!processedUrl.includes("://")) {
                                    processedUrl = "https://www." + processedUrl;
                                }
                                
                                if (typeof goto === 'function') {
                                    try {
                                        goto('../prxy.html?url=' + btoa(processedUrl));
                                    } catch (btoaError) {
                                        console.error('Error encoding URL:', btoaError);
                                        goto('../prxy.html?url=' + encodeURIComponent(processedUrl));
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error in URL input keydown handler:', error);
                    }
                });
            }
        } catch (error) {
            console.error('Error setting up URL input keydown listener:', error);
        }

        function openSettings() {
            try {
                if (typeof addtab === 'function') {
                    addtab("Settings", "settings.html");
                } else {
                    console.error('addtab function not found');
                }
            } catch (error) {
                console.error('Error opening settings:', error);
            }
        }

        function getHomepageURL() {
            try {
                const homepageSetting = localStorage.getItem('axiomHomepage') || 'start.html';
                
                if (homepageSetting === 'custom') {
                    const customUrl = localStorage.getItem('axiomCustomHomepage');
                    if (customUrl && customUrl.trim()) {
                        if (customUrl.startsWith('./') || customUrl.startsWith('axiom://') || customUrl.includes('prxy.html')) {
                            return customUrl;
                        }
                        
                        try {
                            return '../prxy.html?url=' + btoa(customUrl);
                        } catch (btoaError) {
                            console.error('Error encoding custom URL:', btoaError);
                            return '../prxy.html?url=' + encodeURIComponent(customUrl);
                        }
                    }
                    return './start.html';
                }
                
                if (typeof homepageSetting === 'string') {
                    return './' + homepageSetting;
                }
                
                return './start.html';
            } catch (error) {
                console.error('Error getting homepage URL:', error);
                return './start.html';
            }
        }

        function getHomepageTitle() {
            try {
                const homepageSetting = localStorage.getItem('axiomHomepage') || 'start.html';
                
                switch (homepageSetting) {
                    case 'start.html':
                        return 'New Tab';
                    case 'games.html':
                        return 'Games';
                    case 'custom':
                        const customUrl = localStorage.getItem('axiomCustomHomepage');
                        if (customUrl && customUrl.trim()) {
                            try {
                                const url = new URL(customUrl);
                                return url.hostname || 'Custom Page';
                            } catch {
                                return 'Custom Page';
                            }
                        }
                        return 'New Tab';
                    default:
                        return 'New Tab';
                }
            } catch (error) {
                console.error('Error getting homepage title:', error);
                return 'New Tab';
            }
        }

        function getSearchEngine() {
            try {
                const searchEngine = localStorage.getItem('search');
                if (searchEngine && typeof searchEngine === 'string') {
                    return searchEngine;
                }
                return 'https://search.brave.com/search?q=';
            } catch (error) {
                console.error('Error getting search engine:', error);
                return 'https://search.brave.com/search?q=';
            }
        }

        function initDeveloperMode() {
            try {
                const developerMode = localStorage.getItem('axiomDeveloperMode') === 'true';
                
                if (developerMode && !window.eruda) {
                    const script = document.createElement('script');
                    if (!script) return;
                    
                    script.src = 'https://cdn.jsdelivr.net/npm/eruda@3.0.1/eruda.min.js';
                    script.onload = function() {
                        try {
                            if (window.eruda && document.body) {
                                window.eruda.init({
                                    container: document.body,
                                    tool: ['console', 'elements', 'network', 'resource', 'info', 'snippets'],
                                    useShadowDom: true,
                                    autoScale: true,
                                    defaults: {
                                        displaySize: 50,
                                        transparency: 0.9
                                    }
                                });
                                console.log('🛠️ Developer mode enabled - Eruda dev tools loaded');
                            }
                        } catch (initError) {
                            console.error('Error initializing developer tools:', initError);
                        }
                    };
                    
                    script.onerror = function() {
                        console.error('Failed to load developer tools script');
                    };
                    
                    const head = document.head;
                    if (head) {
                        head.appendChild(script);
                    }
                }
            } catch (error) {
                console.error('Error in initDeveloperMode:', error);
            }
        }

        try {
            document.addEventListener('DOMContentLoaded', initDeveloperMode);
        } catch (error) {
            console.error('Error setting up DOMContentLoaded listener for developer mode:', error);
        }

        try {
            window.addEventListener('storage', (e) => {
                try {
                    if (e && e.key === 'axiomDeveloperMode') {
                        if (e.newValue === 'true') {
                            if (typeof initDeveloperMode === 'function') {
                                initDeveloperMode();
                            }
                        } else if (e.newValue === 'false' && window.eruda) {
                            try {
                                window.eruda.destroy();
                                console.log('🛠️ Developer mode disabled - Eruda dev tools removed');
                            } catch (destroyError) {
                                console.error('Error destroying eruda:', destroyError);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error in storage event handler:', error);
                }
            });
        } catch (error) {
            console.error('Error setting up storage listener:', error);
        }

    </script>

    <div id="login-dialog" class="dialog" style="display: none;">
        <h2 id="dialog-title">Login to Axiom</h2>
        <div class="dialog-message">
            <label for="login-email">Email:</label>
            <input type="email" id="login-email" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid var(--theme-textSecondary); border-radius: 5px; background-color: var(--theme-surface); color: var(--theme-textPrimary);" placeholder="Enter your email">
            <label for="login-password">Password:</label>
            <input type="password" id="login-password" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid var(--theme-textSecondary); border-radius: 5px; background-color: var(--theme-surface); color: var(--theme-textPrimary);" placeholder="Enter your password">
            <div id="confirm-password-container" style="display: none;">
                <label for="login-confirm-password">Confirm Password:</label>
                <input type="password" id="login-confirm-password" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid var(--theme-textSecondary); border-radius: 5px; background-color: var(--theme-surface); color: var(--theme-textPrimary);" placeholder="Confirm your password">
            </div>
        </div>
        <div class="dialog-buttons">
            <button class="dialog-button" id="switch-to-signup">Create Account</button>
            <button class="dialog-button dialog-button-positive" id="login-button">Login</button>
            <button class="dialog-button" id="cancel-login">Cancel</button>
        </div>
    </div>

    <script>
        let isSignupMode = false;

        document.getElementById('login-sidebar-button').addEventListener('click', () => {
            // Reset to login mode
            isSignupMode = false;
            document.getElementById('dialog-title').textContent = 'Login to Axiom';
            document.getElementById('login-button').textContent = 'Login';
            document.getElementById('switch-to-signup').textContent = 'Create Account';
            document.getElementById('confirm-password-container').style.display = 'none';
            document.getElementById('login-dialog').style.display = 'block';
        });

        // Switch to signup mode
        document.getElementById('switch-to-signup').addEventListener('click', () => {
            isSignupMode = !isSignupMode;
            if (isSignupMode) {
                document.getElementById('dialog-title').textContent = 'Sign Up for Axiom';
                document.getElementById('login-button').textContent = 'Sign Up';
                document.getElementById('switch-to-signup').textContent = 'Back to Login';
                document.getElementById('confirm-password-container').style.display = 'block';
            } else {
                document.getElementById('dialog-title').textContent = 'Login to Axiom';
                document.getElementById('login-button').textContent = 'Login';
                document.getElementById('switch-to-signup').textContent = 'Create Account';
                document.getElementById('confirm-password-container').style.display = 'none';
            }
        });

        // Login/Signup button handler
        document.getElementById('login-button').addEventListener('click', async () => {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                alert('Please enter both email and password.');
                return;
            }

            // Wait for auth functions to be available
            let retries = 0;
            while ((!window.auth || !window.signInWithEmailAndPassword || !window.createUserWithEmailAndPassword) && retries < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
            }

            if (!window.auth) {
                alert('Authentication system not ready. Please try again.');
                return;
            }

            if (isSignupMode) {
                const confirmPassword = document.getElementById('login-confirm-password').value;
                if (password !== confirmPassword) {
                    alert('Passwords do not match.');
                    return;
                }
                try {
                    const userCredential = await window.createUserWithEmailAndPassword(window.auth, email, password);
                    console.log('Signed up:', userCredential.user);
                    document.getElementById('login-dialog').style.display = 'none';
                    // Clear form
                    document.getElementById('login-email').value = '';
                    document.getElementById('login-password').value = '';
                    document.getElementById('login-confirm-password').value = '';
                } catch (error) {
                    console.error('Signup error:', error);
                    let errorMessage = 'Signup failed. ';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage += 'Email already in use.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage += 'Password is too weak.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage += 'Invalid email address.';
                    } else {
                        errorMessage += 'Please try again.';
                    }
                    alert(errorMessage);
                }
            } else {
                try {
                    const userCredential = await window.signInWithEmailAndPassword(window.auth, email, password);
                    console.log('Logged in:', userCredential.user);
                    document.getElementById('login-dialog').style.display = 'none';
                    // Clear form
                    document.getElementById('login-email').value = '';
                    document.getElementById('login-password').value = '';
                } catch (error) {
                    console.error('Login error:', error);
                    let errorMessage = 'Login failed. ';
                    if (error.code === 'auth/user-not-found') {
                        errorMessage += 'No account found with this email.';
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage += 'Incorrect password.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage += 'Invalid email address.';
                    } else {
                        errorMessage += 'Please check your credentials.';
                    }
                    alert(errorMessage);
                }
            }
        });

        // Cancel button handler
        document.getElementById('cancel-login').addEventListener('click', () => {
            document.getElementById('login-dialog').style.display = 'none';
            // Clear form
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-confirm-password').value = '';
            // Reset to login mode
            isSignupMode = false;
            document.getElementById('dialog-title').textContent = 'Login to Axiom';
            document.getElementById('login-button').textContent = 'Login';
            document.getElementById('switch-to-signup').textContent = 'Create Account';
            document.getElementById('confirm-password-container').style.display = 'none';
        });
    </script>
</body>

<script>
(function() {
    const originalSetAttribute = Element.prototype.setAttribute;
    Element.prototype.setAttribute = function(name, value) {
        if (name === 'src' && this.tagName === 'IFRAME' && value && (value.startsWith('http://') || value.startsWith('https://'))) {
            // Proxy the URL
            value = '../prxy.html?url=' + btoa(value);
        }
        return originalSetAttribute.call(this, name, value);
    };
    const iframe = document.getElementById('iframe');
    if (iframe) {
        let originalSrc = iframe.src;
        Object.defineProperty(iframe, 'src', {
            get: function() { return originalSrc; },
            set: function(value) {
                if (value && (value.startsWith('http://') || value.startsWith('https://'))) {
                    originalSrc = '../prxy.html?url=' + btoa(value);
                } else {
                    originalSrc = value;
                }
                originalSetAttribute.call(this, 'src', originalSrc);
            }
        });
    }

    const urlInput = document.getElementById('url-input');
    if (urlInput) {
        urlInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const url = this.value;
                if (url && (url.startsWith('http://') || url.startsWith('https://') || !url.includes('.'))) {
                    e.preventDefault();
                    iframe.src = '../prxy.html?url=' + btoa(url);
                }
            }
        });
    }
})();
</script>
</html>
</html>